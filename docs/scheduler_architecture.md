# 调度器架构文档（重构版）

## 概述

本文档描述了重构后的调度器系统架构，重点说明模块化设计和组件分离的改进。

## 重构目标

1. **任务模块分离**：每个定时任务独立模块，提高可维护性
2. **公共组件抽取**：统一的错误处理、日志记录、数据库操作
3. **依赖管理优化**：避免循环引用，使用绝对导入
4. **配置集中管理**：所有配置参数集中管理
5. **保持兼容性**：功能行为与原版本完全一致

## 模块结构

### 1. 调度器核心模块

```
src/scheduling/
├── optimized_scheduler.py    # 调度器主模块（重构版）
└── __init__.py
```

**主要功能：**
- 调度器初始化和配置
- 任务注册和管理
- 错误处理和自动恢复
- 优雅退出机制

### 2. 任务模块

```
src/tasks/
├── __init__.py               # 任务接口统一导出
├── table/                    # 数据库表管理任务模块
│   ├── __init__.py
│   └── table_tasks.py
├── env/                      # 环境统计任务模块
│   ├── __init__.py
│   └── env_tasks.py
├── monitoring/               # 设定点监控任务模块
│   ├── __init__.py
│   └── monitoring_tasks.py
├── clip/                     # CLIP推理任务模块
│   ├── __init__.py
│   └── clip_tasks.py
└── decision/                 # 决策分析任务模块
    ├── __init__.py
    └── decision_tasks.py
```

**设计原则：**
- 每个任务模块独立目录，职责清晰
- 统一的接口设计，便于调度器调用
- 完善的错误处理机制
- 清晰的日志输出格式
- 使用绝对导入路径，避免循环依赖

### 3. 公共组件模块

```
src/utils/
├── task_common.py           # 任务公共组件
├── env_data_processor.py    # 环境数据处理器
├── loguru_setting.py        # 日志配置
├── exception_listener.py    # 异常监听器
└── create_table.py          # 数据库表管理
```

**功能说明：**
- `task_common.py`：任务重试装饰器、结果标准化、执行上下文管理
- `env_data_processor.py`：环境数据统计和分析
- 其他工具模块：日志、异常处理、数据库操作

### 4. 全局配置模块

```
src/global_const/
├── global_const.py          # 全局配置和数据库连接
└── const_config.py          # 常量配置（重构版）
```

**配置内容：**
- 库房ID列表
- 任务重试配置
- 调度时间配置
- 数据库连接参数

## 任务接口设计

### 统一接口规范

所有任务模块都遵循以下接口规范：

```python
def safe_task_name() -> None:
    """
    任务安全执行函数
    
    功能：
    - 包含完整的错误处理和重试机制
    - 统一的日志输出格式
    - 不抛出异常，避免影响调度器运行
    """
    pass
```

### 任务执行流程

1. **初始化**：检查数据库连接、验证配置参数
2. **执行**：调用具体的业务逻辑函数
3. **重试**：遇到连接错误时自动重试
4. **记录**：详细的执行日志和结果统计
5. **清理**：资源清理和状态重置

## 定时任务配置

### 任务调度时间表

| 任务名称 | 执行时间 | 功能描述 |
|---------|---------|----------|
| 建表任务 | 启动时执行 | 创建和维护数据库表 |
| 每日环境统计 | 每天 01:03:20 | 计算前一天的环境数据统计 |
| 设定点监控 | 每小时第5分钟 | 监控设定点变更，基于静态配置表 |
| CLIP推理 | 每小时第25分钟 | 处理最近1小时的图像数据 |
| 决策分析 | 每天 10:00, 12:00, 14:00 | 多图像分析和参数调整建议 |

### 配置参数

```python
# 库房配置
MUSHROOM_ROOM_IDS = ["607", "608", "611", "612"]

# 重试配置
TABLE_CREATION_MAX_RETRIES = 3
ENV_STATS_MAX_RETRIES = 3
MONITORING_MAX_RETRIES = 3

# 调度时间配置
DECISION_ANALYSIS_SCHEDULE_TIMES = [(10, 0), (12, 0), (14, 0)]
```

## 错误处理机制

### 分层错误处理

1. **任务级别**：每个任务内部的错误处理和重试
2. **调度器级别**：调度器运行状态监控和恢复
3. **系统级别**：信号处理和优雅退出

### 重试策略

- **连接错误**：自动重试，最大重试次数可配置
- **业务错误**：记录日志，不重试，避免无限循环
- **系统错误**：记录详细信息，尝试恢复或优雅退出

## 日志系统

### 日志格式

```
[TASK_NAME] 日志级别 消息内容
```

### 日志级别

- **INFO**：正常执行信息
- **WARNING**：警告信息，不影响执行
- **ERROR**：错误信息，任务执行失败
- **DEBUG**：调试信息，详细的执行过程

## 部署和运行

### 启动调度器

```bash
cd src
python -m scheduling.optimized_scheduler
```

### 环境要求

- Python 3.8+
- PostgreSQL 数据库
- 相关Python依赖包

### 配置文件

- `src/configs/settings.toml`：主配置文件
- `src/configs/.secrets.toml`：敏感信息配置

## 监控和维护

### 健康检查

调度器提供以下监控接口：

- 任务执行状态
- 数据库连接状态
- 错误统计信息

### 日志监控

重要日志关键词：

- `[SCHEDULER]`：调度器状态
- `[TASK_NAME]`：具体任务执行
- `✅`：成功执行
- `❌`：执行失败
- `⚠️`：警告信息

## 扩展指南

### 添加新任务

1. 在 `src/tasks/` 目录创建新的任务子目录
2. 创建任务模块文件和 `__init__.py` 接口文件
3. 实现 `safe_task_name()` 接口函数
4. 在 `src/tasks/__init__.py` 中导入并导出接口
5. 在调度器中注册任务

**示例：添加新的报告任务**

```bash
# 创建目录结构
mkdir src/tasks/report
touch src/tasks/report/__init__.py
touch src/tasks/report/report_tasks.py
```

```python
# src/tasks/report/__init__.py
from .report_tasks import safe_generate_daily_report

__all__ = ['safe_generate_daily_report']

# src/tasks/__init__.py
from .report import safe_generate_daily_report
```

### 修改调度时间

在 `src/global_const/const_config.py` 中修改相应的时间配置。

### 添加新的公共组件

在 `src/utils/` 目录添加新的工具模块，遵循现有的设计模式。

## 重构效果

### 改进点

1. **模块化程度提升**：每个任务独立目录，便于维护和测试
2. **代码组织优化**：目录结构更加清晰，便于功能扩展
3. **代码复用性增强**：公共组件统一管理，避免重复代码
4. **配置管理优化**：集中配置，便于部署和调整
5. **依赖管理改进**：使用绝对导入路径，避免循环依赖
6. **错误处理完善**：分层处理，提高系统稳定性
7. **文档完整性**：详细的架构文档和使用说明

### 兼容性保证

- 所有定时任务的执行时间保持不变
- 日志输出格式保持一致
- 数据库操作逻辑不变
- 外部接口保持兼容

## 总结

重构后的调度器系统在保持原有功能的基础上，大幅提升了代码的模块化程度和可维护性。通过任务模块分离、公共组件抽取和配置集中管理，系统架构更加清晰，便于后续的功能扩展和维护。