version: '3.8'

x-base: &base
  networks:
    - plant_backend
  environment:
    - TZ=Asia/Shanghai
    - ENVIRONMENT=${ENVIRONMENT:-production}
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "100m"
      max-file: "5"

x-app-service: &app-service
  <<: *base
  pull_policy: if_not_present
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 120s

x-db-deps: &db-deps
  depends_on:
    postgres_db:
      condition: service_healthy

services:
  postgres_db:
    <<: *base
    image: pgvector/pgvector:pg18
    container_name: postgres_db
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB: ${POSTGRES_DB:-mushroom_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      # PostgreSQL 性能调优
      POSTGRES_SHARED_BUFFERS: 128MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 512MB
      POSTGRES_MAINTENANCE_WORK_MEM: 64MB
    secrets:
      - postgres_password
    volumes:
      - postgre_data_v18:/var/lib/postgresql
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 60s
    mem_limit: 512m
    cpus: 2.0

  mushroom_solution:
    <<: [*app-service, *db-deps]
    image: "registry.cn-beijing.aliyuncs.com/ncgnewne/mushroom_solution:${IMAGE_TAG:-latest}"
    container_name: mushroom_solution
    environment:
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      # 数据库连接配置
      POSTGRES_HOST: postgres_db
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-mushroom_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      # AI模型相关配置
      TRANSFORMERS_CACHE: /models/.cache
      HF_HOME: /models/.cache
      TORCH_HOME: /models/.cache
      # CLIP模型配置
      CLIP_MODEL_PATH: /models/clip-vit-base-patch32
      # 禁用HuggingFace遥测
      HF_HUB_DISABLE_TELEMETRY: 1
      TRANSFORMERS_OFFLINE: 0
    volumes:
      - ./configs:/app/configs:ro
      - ./Logs:/app/Logs:rw
      - ./models:/models:rw
      - ./data:/app/data:ro
    ports:
      - "${STREAMLIT_PORT:-7002}:7002"
    mem_limit: 2048m
    cpus: 4.0

volumes:
  postgre_data_v18:
    driver: local

networks:
  plant_backend:
    driver: bridge
    name: plant_backend

secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt