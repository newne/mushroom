services:
  postgres_db:
    image: pgvector/pgvector:pg18
    container_name: postgres_db
    restart: unless-stopped
    environment:
      # ä½¿ç”¨æ ‡å‡†å˜é‡ä»¥ä¾¿ä¸ Secrets å’Œå¥åº·æ£€æŸ¥å…¼å®¹
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB: ${POSTGRES_DB:-mushroom_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      TZ: Asia/Shanghai
    secrets:
      - postgres_password
    volumes:
      - postgre_data:/var/lib/postgresql/data
      - postgre_log:/var/log/postgresql
    # ğŸ”’ ç”Ÿäº§ç¯å¢ƒå®‰å…¨å»ºè®®ï¼šæ³¨é‡Šæ‰ç«¯å£æ˜ å°„ï¼Œç¦æ­¢å¤–éƒ¨ç›´æ¥è®¿é—®
    #    ä¸šåŠ¡æœåŠ¡é€šè¿‡å†…éƒ¨ç½‘ç»œ 'backend' ä½¿ç”¨å®¹å™¨å 'postgres_db' è®¿é—®
    # ports:
    #   - "5432:5432"
    networks:
      - plant_backend # ğŸŒ± ä½¿ç”¨é¡¹ç›®ç›¸å…³ç½‘ç»œå
    healthcheck:
      # å¥åº·æ£€æŸ¥ä½¿ç”¨åŒ $$ è½¬ä¹‰ï¼Œç¡®ä¿åœ¨å®¹å™¨å†…è¯»å–åˆ°æ­£ç¡®çš„ç¯å¢ƒå˜é‡
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-postgres} -d $${POSTGRES_DB:-mushroom_db}"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 256M
        reservations:
          cpus: "0.2"
          memory: 256M

volumes:
  postgre_data:
    driver: local
  postgre_log:
    driver: local

networks:
  plant_backend: # ğŸŒ± ä½¿ç”¨é¡¹ç›®ç›¸å…³ç½‘ç»œå
    driver: bridge
    name: plant_backend
secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
